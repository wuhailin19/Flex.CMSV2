<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="~/Scripts/layui/css/layui2.5.7.css" rel="stylesheet" />
    <script src="~/Scripts/layui/layui2.5.7.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery-3.4.1.min.js" type="text/javascript"></script>
    <script src="~/Scripts/route.js" type="text/javascript"></script>
    <link href="~/Scripts/layui/css/iconfont/iconfont.css" rel="stylesheet" />
    <style>
        html, body { height: 100%; }
        .treeContainer { width: 250px; background: rgb(233, 233, 235); overflow-y: scroll; height: 100%; }
        .layui-body { top: 50px; left: 250px; }
        .layui-tab-title { top: 10px; left: 250px; }

    </style>
</head>
<body>
    <div id="treeContainer" class="treeContainer" style="">
    <div id="test12" class="demo-tree-more"></div>
</div>
<div class="layui-layout layui-layout-admin">
    <!-- 页面标签 -->
    <div class="layui-body" style="" id="nav2">
        <div class="layui-tab" lay-allowclose="true" lay-filter="main_contents">
            <ul class="layui-tab-title" style="" id="main_contents">
            </ul>
            <div class="layui-tab-content">
            </div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript">
    function getparmsbyurl(urllink) {
        if (urllink.indexOf('?') > 0) {
            let links = urllink.split('?')[1];
            if (links.indexOf('&') > 0) {
                let newids = '';
                for (var i = 0; i < links.split('&').length; i++) {
                    newids += links.split('&')[i].split('=')[1] + '_';
                }
                if (newids != '') {
                    newids = newids.substr(0, newids.length - 1);
                    return newids;
                }
            }
        }
    }
    layui.config({
        base: '/Scripts/layui/module/',
    }).use(['element', 'tabrightmenu'], function () {
        let element = layui.element;
        let rightmenu_ = layui.tabrightmenu;

        // 默认方式渲染全部：关闭当前（closethis）、关闭所有（closeall）、关闭其它（closeothers）、关闭左侧所有（closeleft）、关闭右侧所有（closeright）、刷新当前页（refresh）
        rightmenu_.render({
            container: '#nav2',
            filter: 'main_contents',
            navArr: [
                { eventName: 'refresh', title: '刷新当前页' },
                { eventName: 'closethis', title: '关闭当前页' },
                { eventName: 'closeall', title: '关闭所有页' },
                { eventName: 'closeothers', title: '关闭其它页' }
            ],
            isClickMidCloseTab: true
        });
    });
    layui.use(['tree', 'util'], function () {
        var tree = layui.tree
            , layer = layui.layer
            , util = layui.util
            //模拟数据
            , columnlist = [];
         ajaxHttp({
            url: api + 'ColumnCategory/GetManageTreeListAsync',
            type: 'Get',
            //data: { _type: 'getTreeColumn' },
            async: false,
            success: function (json) {
                if (json.code == 200) {
                    columnlist = json.content;
                }
            },
            complete: function () { }
        })
        //基本演示
        tree.render({
            elem: '#test12'
            , data: columnlist
            , showCheckbox: false  //是否显示复选框
            , id: 'demoId1'
            , icon: 'layui-icon layui-icon-file'
            , isJump: true //是否允许点击节点时弹出新窗口跳转
            , onlyIconControl: true
            , click: function (obj) {
                //var data = obj.data;  //获取当前点击的节点数据
                //layer.msg('状态：' + obj.state + '<br>节点数据：' + JSON.stringify(data));
            }, operate: function () {
                $('.demo-tree-more a').each(function () {
                    //alert($(this).attr('target'))
                    $(this).attr('target', 'right');
                })
            }
        });
    })
    var items = new Array();
    var index = 0;
    layui.use('element', function () {
        var element = layui.element;
        $('.demo-tree-more').on('click', '.layui-tree-txt', function (e) {
            e.preventDefault();
            let linkurl = $(this).attr('href');
            let ids = getparmsbyurl(linkurl);
            if (linkurl.indexOf('javascript:') != -1) {
                return;
            }
            if (items.indexOf(ids) == -1) {
                items[index] = ids;
                index++;//避免值被覆盖
                element.tabAdd("main_contents", {
                    title: $(this).text(),
                    id: ids,
                    content: '<div class="loadings">' +
                        '<i class="layui-icon layui-anim layui-anim-loop">&#xe63d;</i>' +
                        '<iframe src="' + linkurl + '" class="layadmin-iframe" id="iframe' + ids + '" frameborder="0"></iframe>' +
                        '</div>'
                });
                element.tabChange("main_contents", ids);
            } else {
                element.tabChange("main_contents", ids);
            }
        });
        //监听Tab切换，以改变地址hash值
        element.on('tab(main_contents)', function () {
            let iframe = document.getElementById('iframe' + this.getAttribute('lay-id'));
            if (iframe != undefined) {
                if (iframe.attachEvent) {
                    iframe.attachEvent("onload", function () {
                        $('.loadings .layui-anim-loop').hide();
                    });
                } else {
                    iframe.onload = function () {
                        $('.loadings .layui-anim-loop').hide();
                    };
                }
            }
        });
        //监听tab
        element.on('tabDelete(main_contents)', function (data) {
            var ind = data.index;
            var newArray = new Array();
            for (var i = 0; i < items.length; i++) {
                if (i < ind) {
                    newArray[i] = items[i];
                } else if (i > ind) {
                    newArray[i - 1] = items[i];
                }
            }
            items = newArray;
            console.log(items)
            index--;
        });
    })
</script>