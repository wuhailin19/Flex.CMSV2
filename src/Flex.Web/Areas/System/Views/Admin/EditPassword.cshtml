@{
    Layout = null;
}
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="~/Scripts/layui/css/layui.css" rel="stylesheet" /><link href="~/Scripts/layui/css/iconfont/iconfont.css" rel="stylesheet" />
    <script src="~/Scripts/layui/layui.js" type="text/javascript"></script><script src="~/Scripts/route.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery-1.8.2.min.js" type="text/javascript"></script>
    <link href="~/Scripts/iconfont/iconfont.css" rel="stylesheet" />
    <style>
        .layui-form-item .layui-form-label { text-align: center; }
        .edui-editor.edui-default { width: 100% !important; }
        .layui-input-block > .edui-default { width: 100% !important; }
        .layui-select-title .layui-anim.layui-anim-upbit { display: none; }
        .iconclear { width: 35px; display: inline-block; height: 16px; padding: 2px; background-color: #393D49; text-align: center; line-height: 16px; color: #fff; cursor: pointer; }
        .layui-layer-page { width: 95% !important; }
        .layui-col-xs9 { width: 70% }
        .img-box { width: auto !important; border: 4px solid rgb(102, 177, 255); border-radius: 3px; cursor: pointer; overflow: hidden; background-color: #999; }
        .message-info { width: auto !important; line-height: 50px; color: #535353 }
        .img-box .img-box-corner { position: absolute; right: -11px; bottom: -11px; width: 20px; height: 20px; background-color: rgb(102, 177, 255); transform: rotate( 40deg ); }
        .tips {display:none; width: 100%; background-color: #ff0000; color: #fff; height: 20px; border: 1px solid #fff; line-height: 20px; text-align: center; }
        .tips.active { background-color: rgb(102, 177, 255); border-color: rgb(102, 177, 255); }
    </style>
</head>
<body>
    <form class="layui-form" action="" style="padding: 2%;" lay-filter="formTest">
        <div class="layui-form-item" style="display:none;">
            <label class="layui-form-label">编号</label>
            <div class="layui-input-block">
                <input type="text" name="AdminId" readonly="readonly" autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">账号</label>
            <div class="layui-input-block">
                <input type="text" name="LoginName" required lay-verify="required" placeholder="请输入账号" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-inline" style="width:40%;">
                <input type="password" name="Password" placeholder="请输入密码" autocomplete="new-password" class="layui-input">
            </div>
            <div class="layui-input-inline" style="width: 20px;margin-top:10px ">
                <span href="javascript:void(0);" class="show" style="text-decoration:none;"><i class="iconfont iconyanjing_bi" data-bind="Password"></i></span>
            </div>
            <div class="layui-input-inline" style="width:100px;margin-top:10px">
                <p class="tips" id="pwChar">长度8-30</p>
                <p class="tips" id="pwLower">包含小写字母</p>
                <p class="tips" id="pwCap">包含大写字母</p>
                <p class="tips" id="pwNum">包含数字</p>
                <p class="tips" id="pwOther">包含特殊符号</p>
            </div>
            <div class="layui-input-inline" style="width:30%;margin-top:10px">
                留空则不修改
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">确认密码</label>
            <div class="layui-input-inline" style="width:40%;">
                <input type="password" name="CheckPwd" placeholder="请确认密码" autocomplete="new-password" class="layui-input">
            </div>
            <div class="layui-input-inline" style="width: 20px;margin-top:10px ">
                <span href="javascript:void(0);" class="show" style="text-decoration:none;"><i class="iconfont iconyanjing_bi" data-bind="CheckPwd"></i></span>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary" id="reset">重置</button>
            </div>
        </div>
    </form>
    <script>
        $(".show").on("click", ".iconyanjing_bi", function () {
            $(this).removeClass("iconyanjing_bi").addClass("iconyanjing_kai");
            $('input[name=' + $(this).data('bind') + ']').attr("type", "text");
        });
        $(".show").on("click", ".iconyanjing_kai", function () {
            $(this).removeClass("iconyanjing_kai").addClass("iconyanjing_bi");
            $('input[name=' + $(this).data('bind') + ']').attr("type", "password");
        });


        // 操作列tips
        var ischeck = false;
        layui.config({
            base: '/Scripts/layui/module/cropper/' //layui自定义layui组件目录
        }).use(['form', 'croppers'], function () {
            var form = layui.form, croppers = layui.croppers, layer = layui.layer;
            var tips = {
                timeout: 2000,
                msgboxtime: 1000,
                index: undefined,
                showProStatus: function ($emlemt, msg) {
                    tips.index = layer.tips(msg, $emlemt, {
                        tips: 2,
                        time: tips.timeout     // 3秒消失
                    })
                },
                showSuccess: function (msg) {
                    layer.msg(msg, { icon: 6, time: tips.msgboxtime }, function () { });
                },
                showFail: function (msg) {
                    layer.msg(msg, { icon: 5, time: tips.msgboxtime }, function () { });
                },
                closeTips: function () {
                    layer.close(tips.index);
                }
            }
            var parent_json;
            $.ajax({
                url: api + 'Admin/getLoginInfo',
                type: 'Get',
                datatype: 'json',
                async: false,
                success: function (result) {
                    let json = JSON.parse(result);
                    if (json.code == 200) {
                        parent_json = json.data[0];
                    } else {
                        layer.msg(json.msg, { icon: 5, time: 1000 });
                    }
                }
            })
            //创建一个头像上传组件
            croppers.render({
                elem: '#editimg'
                , saveW: 150     //保存宽度
                , saveH: 150
                , mark: 1 / 1    //选取比例
                , area: '900px'  //弹窗宽度
                , url: "OnloadUserAvatar"  //图片上传接口返回和（layui 的upload 模块）返回的JOSN一样
                , done: function (data) { //上传完毕回调
                    $("#inputimgurl").val(data);
                    $("#srcimgurl").attr('src', "/" + data);
                }
            });
            var password = $('input[name=Password]');
            var isvalid = false;
            var helperText = {
                charLength: $('#pwChar'),
                lowercase: $('#pwLower'),
                uppercase: $('#pwCap'),
                number: $('#pwNum'),
                other: $('#pwOther'),
            };
            var pattern = {
                charLength: function () {
                    if (password.val().length >= 8) {
                        return true;
                    }
                },
                lowercase: function () {
                    var regex = /^(?=.*[a-z]).+$/;
                    if (regex.test(password.val())) {
                        return true;
                    }
                },
                uppercase: function () {
                    var regex = /^(?=.*[A-Z]).+$/;
                    if (regex.test(password.val())) {
                        return true;
                    }
                },
                number: function () {
                    var regex = /^(?=.*[0-9]).+$/;
                    if (regex.test(password.val())) {
                        return true;
                    }
                },
                other: function () {
                    var regex = /^(?=([\x21-\x7e]+)[^a-zA-Z0-9]).+$/;
                    if (regex.test(password.val())) {
                        return true;
                    }
                }
            };
            function checkAll() {
                if (password.val().length >= 1) {
                    $('.tips').show();
                    validClass(pattern.charLength(), helperText.charLength);
                    validClass(pattern.lowercase(), helperText.lowercase);
                    validClass(pattern.uppercase(), helperText.uppercase);
                    validClass(pattern.number(), helperText.number);
                    validClass(pattern.other(), helperText.other);
                    if (pattern.charLength()
                        && pattern.lowercase()
                        && pattern.uppercase()
                        && pattern.number()
                        && pattern.other()
                    ) {
                        isvalid = true;
                    } else {
                        isvalid = false;
                    }
                }
                else {
                    $('.tips').hide(); isvalid = true;
                }
            }
            function validClass(result, $element) {
                if (result) {
                    $element.addClass('active');
                }
                else { $element.removeClass('active');}
            }
            $('input[name=Password]').keyup(function () {
                checkAll();
            })
            $('input[name=CheckPwd]').blur(function () {
                let checkpwd = $(this).val();
                let pwd = $('input[name=Password]').val();
                if (checkpwd === pwd) {
                    ischeck = true;
                    tips.closeTips();
                    return;
                }
                ischeck = false;
                tips.showProStatus($(this), "两次密码不一致")
            })
            function formRender() {
                form.val("formTest", {
                    'AdminId': parent_json.AdminId
                    , 'LoginName': parent_json.LoginName
                });
                $('#srcimgurl').attr('src', "/" + parent_json.UserAvatar);
            }
            formRender();
            $('#editimg').attr('data-id', parent_json.AdminId);
            //监听提交
            form.on('submit(formDemo)', function (data) {
                if (password.val().length >= 1) {
                    if (!isvalid) {
                        password.focus();
                        tips.showProStatus(password, "密码不符合规范");
                        return false;
                    }
                    if (!ischeck) {
                        tips.showProStatus($('input[name=CheckPwd]'), "请确认密码")
                        $('input[name=CheckPwd]').focus();
                        return false;
                    }
                }
                $.ajax({
                    url: api + 'Admin/UpdatePassword',
                    type: 'Post',
                    datatype: 'json',
                    data: JSON.stringify(data.field),
                    async: false,
                    success: function (result) {
                        let json = JSON.parse(result);
                        if (json.code == 200) {
                            layer.msg(json.msg, { icon: 6, time: 300 }, function () {
                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                parent.layer.close(index); //再执行关闭
                                window.location.href = "/sljc_dfe0-154xwq2kjfc/loginout.aspx";
                            });
                        } else {
                            layer.msg(json.msg, { icon: 5, time: 3000 });
                        }
                    },
                    complete: function () {

                    }
                })
                return false;
            });
            $('#reset').click(function () {
                formRender();
                return false;
            })
        });
    </script>
</body>
</html>