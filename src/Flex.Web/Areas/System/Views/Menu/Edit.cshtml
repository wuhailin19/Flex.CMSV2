@{
    Layout = null;
}
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="~/Scripts/layui/css/layui.css" rel="stylesheet" /><link href="~/Scripts/layui/css/iconfont/iconfont.css" rel="stylesheet" />
    <script src="~/Scripts/layui/layui.js" type="text/javascript"></script><script src="~/Scripts/route.js" type="text/javascript"></script>
    <script src="~/Scripts/jquery-1.8.2.min.js" type="text/javascript"></script>
    <style>
        .layui-form-item .layui-form-label { text-align: center; }
        .edui-editor.edui-default { width: 100% !important; }
        .layui-input-block > .edui-default { width: 100% !important; }
        .layui-select-title .layui-anim.layui-anim-upbit { display: none; }
    
    </style>
</head>
<body>
    <form class="layui-form" action="" style="padding: 2%;" lay-filter="formTest">
        <div class="layui-form-item">
            <label class="layui-form-label">编号</label>
            <div class="layui-input-block">
                <input type="text" name="ID" readonly="readonly" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">菜单</label>
            <div class="layui-input-block">
                <input type="text" name="Name" required lay-verify="required" placeholder="请输入菜单名" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">图标种类</label>
                <div class="layui-input-inline">
                    <select name="FontSort" lay-search="" id="FontSort" lay-filter="FontSort">
                        <option value="fontclass">layuifont</option>
                        <option value="iconfont">iconfont</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">图标</label>
            <div class="layui-input-block" id="icon_click">
                <input type="text" name="Icode" placeholder="请输入图标" autocomplete="off" class="layui-input" id="iconHhysFa" lay-filter="iconHhysFa">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">父级选择框</label>
            <div class="layui-input-block">
                <div class="layui-form-select downpanel">
                    <div class="layui-select-title">
                        <select name="ParentID" id="chooseName">
                            <option value="-1">无</option>
                        </select>
                    </div>
                    <dl class="layui-anim layui-anim-upbit">
                        <dd>
                            <div id="ParentID" class="demo-tree-more"></div>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">显示状态</label>
            <div class="layui-input-block">
                <input type="checkbox" name="Status" lay-skin="switch" lay-text="开启|关闭" value="true">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">目录</label>
            <div class="layui-input-block">
                <input type="checkbox" name="isMenu" lay-skin="switch" lay-text="是|否" value="true">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">链接类型</label>
            <div class="layui-input-block">
                <input type="checkbox" name="IsControllerUrl" lay-skin="switch" lay-text="aspx|mvc" value="true">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">链接地址</label>
            <div class="layui-input-block">
                <input type="text" name="LinkUrl" placeholder="请输入链接地址" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">排序号</label>
            <div class="layui-input-block">
                <input type="text" name="OrderId" placeholder="请输入排序号" autocomplete="off" class="layui-input" value="0">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
    <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js"></script>
    <script>
        var parent_json = parent.req_Data;
        //Demo
        $.ajax({
            url: api + 'TreeMenu/getTreeColumnStr',
            type: 'Get',
            //data: { _type: 'getTreeColumnStr' },
            async: false,
            success: function (result) {
                let json = JSON.parse(result);
                if (json.code == 200) {
                    for (var i = 0; i < json.data.length; i++) {
                        $('#chooseName').append('<option value="' + json.data[i].id + '" ' + (parent_json.ParentID == json.data[i].id?"selected":"")+'>' + json.data[i].title + '</option>');
                    }
                }
            },
            complete: function () {

            }
        })
        layui.config({
            base: '/Scripts/layui/module/'
        }).extend({
            iconHhysFa: 'iconHhysFa'
        }).use(['iconHhysFa', 'form', 'tree'], function () {
            var form = layui.form;
            var tree = layui.tree;
            var iconHhysFa = layui.iconHhysFa;
            var fonttype = parent_json.FontSort;
            var icondom = iconHhysFa.render({
                // 选择器，推荐使用input
                elem: '#iconHhysFa',
                // 数据类型：fontClass/awesome，推荐使用fontClass
                type: fonttype,
                fonttype: fonttype,
                // 是否开启搜索：true/false，默认true
                search: true,
                // 是否开启分页：true/false，默认true
                page: true,
                // 每页显示数量，默认12
                limit: 12,
                url: '/Scripts/iconfont/iconfont.css',
                // 点击回调
                click: function (data) {
                },
                // 渲染成功后的回调
                success: function (d) {

                }
            });
            form.on('select(FontSort)', function (data) {
                iconHhysFa.remove();
                fonttype = data.value;
                icondom = iconHhysFa.render({
                    elem: '#iconHhysFa',
                    type: fonttype,
                    fonttype: fonttype,
                    search: true,
                    page: true,
                    limit: 12,
                    url: '/Scripts/iconfont/iconfont.css'
                });
            });
            $('#icon_click').delegate('#icon_clear', 'click', function () {
                iconHhysFa.clearValue("iconHhysFa", fonttype);
                $('#iconHhysFa').val('');
                console.log($('#iconHhysFa').val())
            })
            
            form.val("formTest", {
                'Name': parent_json.Name
                , 'ID': parent_json.ID
                , 'ParentID': parent_json.ParentID
                , 'FontSort': parent_json.FontSort
                , 'Icode': parent_json.Icode
                , 'Status': parent_json.Status
                , 'LinkUrl': parent_json.LinkUrl
                , 'OrderId': parent_json.OrderId
                , 'isMenu': parent_json.isMenu
                , 'IsControllerUrl': parent_json.IsControllerUrl
            });
            iconHhysFa.checkIcon("iconHhysFa", parent_json.Icode == undefined ? '' : parent_json.Icode, fonttype);

            //监听提交
            form.on('submit(formDemo)', function (data) {
                console.log(parent_json)
                $.ajax({
                    url: api + 'Menu/Update',
                    type: 'Post',
                    datatype: 'json',
                    data: JSON.stringify(data.field),
                    //data: { _type: 'UpdateMenuInfo', _data: JSON.stringify(data.field) },
                    async: false,
                    success: function (result) {
                        let json = JSON.parse(result);
                        if (json.code == 200) {
                            layer.msg(json.msg, { icon: 6, time: 300 }, function () {
                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                parent.layer.close(index); //再执行关闭

                                parent.parent.Init();
                            });
                        } else {
                            layer.msg(json.msg, { icon: 5, time: 1000 });
                        }

                    },
                    complete: function () {

                    }
                })
                return false;
            });

            var columnlist;
            $.ajax({
                url: api + 'TreeMenu/getTreeColumn',
                type: 'Get',
                //data: { _type: 'getTreeColumn' },
                async: false,
                success: function (result) {
                    let json = JSON.parse(result);
                    if (json.code == 200) {
                        columnlist = json.data;
                    }
                },
                complete: function () { }
            })

            var tree = layui.tree;
            tree.render({
                elem: '#ParentID',
                data: columnlist
                , onlyIconControl: true
                , click: function (obj) {
                    $("#chooseName").val(obj.data.id);
                    form.render();
                }
            });
            //下拉交互显示
            $(".downpanel").on("click", ".layui-select-title", function (e) {
                $(".downpanel").not($(this).parents(".downpanel")).removeClass("layui-form-selected");
                $(this).parents(".downpanel").toggleClass("layui-form-selected");
                layui.stope(e);
            }).on("click", "dl i", function (e) {
                layui.stope(e);
            });
            $(document).on("click", function (e) {
                $(".downpanel").removeClass("layui-form-selected");
            });
        });
    </script>
</body>
</html>